<planning_base>
    <div class="row">
        <div id="side-menu">
            <div>
                <ul class="navigation">
                    <ul>
                        <li class="{ state.page === 'dashboard' ? 'active' : '' }" data-page="dashboard"
                            onclick="{ selectPage }">{ window.gettext("Dashboard") }</li>
                        <li class="{ state.page === 'plans' ? 'active' : '' }" data-page="plans"
                            onclick="{ selectPage }">{ window.gettext("Plans") }</li>
                        <li class="{ state.page === 'create' ? 'active' : '' }" data-page="create"
                            onclick="{ selectPage }">{ window.gettext("Planning Templates") }</li>
                    </ul>
                </ul>
            </div>
        </div>
        <div id="planning">
            <loading messageHeader="{ window.gettext('Please Wait') }"></loading>
            <planning_dashboard if="{ state.page === 'dashboard' }"></planning_dashboard>
            <planning if="{ state.page === 'plans' }"></planning>
            <planning_templates if="{ state.page === 'create' }"></planning_templates>
            <footer>
                <small>República Democrática de Timor-Leste / Ministério das Obras Públicas</small>
                <small>{ window.gettext("Created by Catalpa International") }</small>
            </footer>
        </div>
    </div>

    <script>
        import Planning_Dashboard from './planning_dashboard.riot.html';
        import Planning from './planning.riot.html';
        import Planning_Templates from './planning_templates.riot.html';
        import Loading from "./loading.riot.html";

        export default {
            state: {
                page: "dashboard",
                nextPage: null,
            },
            components: {
                Planning_Dashboard,
                Planning,
                Planning_Templates,
                Loading,
            },
            onBeforeMount(props, state) {
                state.page = props.page;
                window.addEventListener("hashchange", this.hashCheck);
                window.goBack = this.goBack;
            },
            onBeforeUnmount() {
                window.removeEventListener("hashchange", this.hashCheck);
                window.goBack = () => {};
            },
            hashCheck() {
                const planningHash = /#planning\/(.*)\/?/.exec(location.hash);

                if (planningHash) {
                    this.update({page: planningHash[1]});
                }
            },
            selectPage(e) {
                this.state.page = e.currentTarget.dataset.page;
                this.state.nextPage = `#planning/${this.state.page}`;
                if (this.hasChanges()) {
                    this.modalHandler();
                } else {
                    this.discardChanges();
                }
            },
            hasChanges() {
                return false;
            },
            modalHandler() {
                document.addEventListener("edit.stop-alert.result", (data) => {
                    const stopAlertResult = data.detail.result;

                    // Ensure that the dialog gets hidden
                    $("#stop-alert").modal("hide");

                    if (stopAlertResult === "discard") {
                        this.discardChanges();
                    }
                }, {once: true});

                $("#stop-alert").modal("show");
            },
            discardChanges() {
                window.location.hash = this.state.nextPage;
                this.update();
            },
            showFeedback(error) {
                this.update({
                    showFeedback: true,
                    error: error,
                });
                setTimeout(() => this.closeFeedback(), 2000);
            },
            closeFeedback() {
                const feedback = document.getElementsByClassName("slide-in").item(0);

                if (feedback) {
                    feedback.classList.add("slide-out");
                    setTimeout(() => {
                        feedback.classList.remove("slide-out");
                        this.update({showFeedback: false});
                    }, 300);
                }
            },
            goBack() {
                window.location.hash = "#";
            },
        }
    </script>
</planning_base>
