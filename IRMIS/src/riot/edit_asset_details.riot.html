<edit_asset_details>
    <h5>{ window.gettext("Asset") }</h5>

    <section>
        <h6>{ window.gettext("Link code and name") }</h6>
        <div class="form-group">
            <label>{ link_code.display }</label>
            <input class="{ state.errors.linkCode ? 'danger' : null } { state.linkCode ? '' : 'inactive' } form-control"
                type="text" maxlength="25" placeholder="A01-01" value="{ state.linkCode }" oninput="{ checkLinkCode }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_code") }</small>
            <div if="{ state.errors.linkCode }" class="invalid-tooltip">
                <ul>
                    <li>{ state.errors.linkCode }.</li>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <label>{ link_start_name.display }</label>
            <input class="{ state.linkStartName ? '' : 'inactive' } form-control" type="text" maxlength="150"
                placeholder="Dili" value="{ state.linkStartName }" oninput="{ checkLinkStartName }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_start_name") }</small>
        </div>
        <div class="form-group">
            <label>{ link_end_name.display }</label>
            <input class="{ state.linkEndName ? '' : 'inactive' } form-control" type="text" maxlength="150"
                placeholder="Manatuto" value="{ state.linkEndName }" oninput="{ checkLinkEndName }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_end_name") }</small>
        </div>
    </section>

    <section>
        <h6>{ window.gettext("Link width and length") }</h6>
        <div class="form-group">
            <label>{ link_length.display }</label>
            <input
                class="{ state.errors.linkLength ? 'danger' : null } { state.linkLength != null && state.linkLength !== '' ? '' : 'inactive' } form-control"
                type="number" placeholder="58.7" value="{ state.linkLength }" oninput="{ checkLinkLength }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_length") }</small>
            <div if="{ state.errors.linkLength }" class="invalid-tooltip">
                <ul>
                    <li>{ state.errors.linkLength }.</li>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <label>{ carriageway_width.display }</label>
            <input
                class="{ state.errors.carriageWidth ? 'danger' : null } { state.carriagewayWidth != null && state.carriagewayWidth !== '' ? '' : 'inactive' } form-control"
                type="number" placeholder="5.0" value="{ state.carriagewayWidth }" oninput="{ checkCarriagewayWidth }">
            <small class="form-text text-muted">{ props.parent.getHelpText("carriageway_width") }</small>
            <div if="{ state.errors.carriageWidth }" class="invalid-tooltip">
                <ul>
                    <li>{ state.errors.carriageWidth }.</li>
                </ul>
            </div>
        </div>
    </section>

    <section>
        <h6>{ window.gettext("Link chainage") }</h6>
        <div class="form-group">
            <label>{ link_start_chainage.display } (m)</label>
            <input
                class="{ state.errors.linkStartChainage ? 'danger' : null } { state.linkStartChainage != null && state.linkStartChainage !== '' ? '' : 'inactive' } form-control"
                type="number" placeholder="0" value="{ state.linkStartChainage }" oninput="{ checkLinkStartChainage }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_start_chainage") }</small>
            <div if="{ state.errors.linkStartChainage }" class="invalid-tooltip">
                <ul>
                    <li>{ state.errors.linkStartChainage }.</li>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <label>{ link_end_chainage.display } (m)</label>
            <input
                class="{ state.errors.linkEndChainage ? 'danger' : null } { state.linkEndChainage != null && state.linkEndChainage !== '' ? '' : 'inactive' } form-control"
                type="number" placeholder="62410" value="{ state.linkEndChainage }" oninput="{ checkLinkEndChainage }">
            <small class="form-text text-muted">{ props.parent.getHelpText("link_end_chainage") }</small>
            <div if="{ state.errors.linkEndChainage }" class="invalid-tooltip">
                <ul>
                    <li>{ state.errors.linkEndChainage }.</li>
                </ul>
            </div>
        </div>
    </section>

    <section>
        <h6>{ window.gettext("Road class") }</h6>
        <div class="form-group">
            <label>{ technical_classes.display }</label>
            <small class="form-text text-muted">{ props.parent.getHelpText("technical_class") }</small>
            <ul class="technical-class">
                <li each="{ technical_class in technical_classes.options }" data-technical="{ technical_class.code }"
                    onclick="{ checkTechnicalClass }">
                    <span class="{ technical_class.code == state.technicalClass ? 'active' : ''  } radio image"></span>
                    { technical_class.name }
                </li>
            </ul>
        </div>
    </section>

    <div class="button-wrapper d-flex justify-content-end">
        <button class="btn btn-primary" onclick="{ save }"
            disabled="{ props.saving || Object.entries(state.errors).length > 0 }">{ window.gettext("Save and continue")
            }</button>
    </div>

    <script>
        export default {
            state: {
                linkChainageDecimals: 5,
                linkChainageDigits: 12,
                linkLengthDecimals: 3,
                linkLengthDigits: 8,
                carriagewayWidthDecimals: 3,
                carriagewayWidthDigits: 5,
                errors: {},
            },
            onBeforeMount(props, state) {
                state.linkCode = props.road.getLinkCode();
                state.linkStartName = props.road.getLinkStartName();
                state.linkEndName = props.road.getLinkEndName();
                state.linkLength = props.road.getLinkLength().toFixed(3);
                state.carriagewayWidth = props.road.getCarriagewayWidth();
                state.linkStartChainage = props.road.getLinkStartChainage();
                state.linkEndChainage = props.road.getLinkEndChainage();
                state.technicalClass = props.road.getTechnicalClass();
            },
            save(e) {
                if (Object.entries(this.state.errors).length == 0) {
                    this.props.parent.save();
                }
            },
            checkLinkCode(e) {
                let value = e.currentTarget.value.trim();

                if (containsWhiteSpaces(value)) {
                    this.state.errors.linkCode = window.gettext('Link code cannot contain white spaces');
                } else {
                    delete this.state.errors.linkCode;
                    this.state.linkCode = value;
                    this.props.road.setLinkCode(value);
                }
                this.update();
            },
            checkLinkStartName(e) {
                this.state.linkStartName = e.currentTarget.value;
                this.props.road.setLinkStartName(this.state.linkStartName);
                this.update();
            },
            checkLinkEndName(e) {
                this.state.linkEndName = e.currentTarget.value;
                this.props.road.setLinkEndName(this.state.linkEndName);
                this.update();
            },
            checkLinkLength(e) {
                let value = e.currentTarget.value;
                if (exceedsMaxDigits(value, this.state.linkLengthDigits, this.state.linkLengthDecimals)) {
                    this.state.errors.linkLength = window.interpolate(
                        window.gettext('Link length cannot contain more than %s digits, of which %s are decimals'),
                        [this.state.linkLengthDigits, this.state.linkLengthDecimals]
                    );
                } else {
                    delete this.state.errors.linkLength;
                    this.state.linkLength = value;
                    this.props.road.setLinkLength(value);
                }
                this.update();
            },
            checkCarriagewayWidth(e) {
                let value = e.currentTarget.value;
                if (exceedsMaxDigits(value, this.state.carriagewayWidthDigits, this.state.carriagewayWidthDecimals)) {
                    this.state.errors.carriageWidth = window.interpolate(
                        window.gettext('Carriage width cannot contain more than %s digits, of which %s are decimals'),
                        [this.state.carriagewayWidthDigits, this.state.carriagewayWidthDecimals]
                    );
                } else {
                    delete this.state.errors.carriageWidth;
                    this.state.carriagewayWidth = value;
                    this.props.road.setCarriagewayWidth(value);
                }
                this.update();
            },
            checkLinkStartChainage(e) {
                let value = e.currentTarget.value;
                if (exceedsMaxDigits(value, this.state.linkChainageDigits, this.state.linkChainageDecimals)) {
                    this.state.errors.linkStartChainage = window.interpolate(
                        window.gettext('Link start chainage cannot contain more than %s digits, of which %s are decimals'),
                        [this.state.linkChainageDigits, this.state.linkChainageDecimals]
                    );
                } else {
                    delete this.state.errors.linkStartChainage;
                    this.state.linkStartChainage = value;
                    this.props.road.setLinkStartChainage(value);
                }
                this.update();
            },
            checkLinkEndChainage(e) {
                let value = e.currentTarget.value;
                if (exceedsMaxDigits(value, this.state.linkChainageDigits, this.state.linkChainageDecimals)) {
                    this.state.errors.linkEndChainage = window.interpolate(
                        window.gettext('Link end chainage cannot contain more than %s digits, of which %s are decimals'),
                        [this.state.linkChainageDigits, this.state.linkChainageDecimals]
                    );
                } else {
                    delete this.state.errors.linkEndChainage;
                    this.state.linkEndChainage = value;
                    this.props.road.setLinkEndChainage(value);
                }
                this.update();
            },
            checkTechnicalClass(e) {
                this.state.technicalClass = e.currentTarget.dataset.technical;
                this.props.road.setTechnicalClass(this.state.technicalClass);
                this.update();
            },
            link_code: window.road_schema.link_code,
            link_start_name: window.road_schema.link_start_name,
            link_end_name: window.road_schema.link_end_name,
            link_length: window.road_schema.link_length,
            carriageway_width: window.road_schema.carriageway_width,
            link_start_chainage: window.road_schema.link_start_chainage,
            link_end_chainage: window.road_schema.link_end_chainage,
            technical_classes: window.road_schema.technical_class,
        };

        function containsWhiteSpaces(text) {
            return /\s/.test(text);
        }

        function exceedsMaxDigits(text, limit, decimals) {
            return !(new RegExp("^\\d{0," + (limit - decimals) + "}(\\.\\d{1," + decimals + "})?$").test(text));
        }
    </script>
</edit_asset_details>
