<upload_photo>
    <div show="{state.photo.url == state.basePhoto.url}" class="photo-upload-area">
        <form class="dropzone">
            <div class="cloud-box">
                <div class="upload-cloud"></div>
                <div class="upload-instructions">{ window.gettext("Click to upload") }</div>
                <div>{ window.gettext("Maximum file size 500KB") }</div>
                <div>{ window.gettext("Accepted file formats: JPEG, GIF, PNG") }</div>
            </div>
        </form>
    </div>
    <div show="{state.photo.url != state.basePhoto.url}" class="photo-management-area">
        <img src="{state.photo.url}" style="max-width: 400px;">
        <input
            class="{ state.errors.description ? 'danger' : null } { state.photo.description ? '' : 'inactive' } form-control upload-text"
            type="text" maxlength="500" placeholder="Enter a description of the photo"
            value="{ state.photo.description }" onblur="{updateDescription}">
        <button class="btn btn-md btn-danger" onclick="{deletePhoto}">Delete Photo</button>
    </div>

    <script>
        import Dropzone from "dropzone";
        import {ConfigAPI} from "../assets/configAPI";
        import {putPhotoData, deletePhotoData} from "../assets/photoAPI";
        import {EstradaPhoto} from "../assets/models/photo";

        export default {
            state: {
                errors: {},
            },
            onBeforeMount(props, state) {
                state.basePhoto = new EstradaPhoto();
                state.photo = props.photo || new EstradaPhoto();
            },
            onMounted(props, state) {
                Dropzone.autoDiscover = false;
                const myDropzone = new Dropzone(this.$('form.dropzone'), {
                    url: `${ConfigAPI.requestAssetUrl}/photo_create`,
                    method: "post",
                    headers: {'X-CSRFToken': document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*\=\s*([^;]*).*$)|^.*$/, "$1")},
                    params: {fk_link: props.fkLink},
                    maxFiles: 1,
                    maxFilesize: 0.5, // MB
                    acceptedFiles: '.jpeg,.jpg,.gif,.png',
                    dictDefaultMessage: '',
                    dictInvalidFileType: 'Not a valid image, please submit a JPEG, GIF, or PNG',
                    accept: (file, done) => {done();}
                });

                myDropzone.on("success", function(file, res) {
                    myDropzone.disable();
                    state.photo.setId(res.id);
                    state.photo.setUrl(res.url);
                    state.photo.setFkLink(res.fk_link);
                });

                this.update();
            },
            updatePhoto() {
                putPhotoData(this.state.photo)
                    .then((data) => {
                        this.props.showFeedback();
                    }).catch((err) => {
                        this.props.showFeedback(true);
                    }).finally((r) => {
                        this.update();
                    });
            },
            deletePhoto(e) {
                deletePhotoData(this.state.photo)
                    .then((data) => {
                        this.state.photo = new EstradaPhoto();
                        this.props.showFeedback();
                    }).catch((err) => {
                        this.props.showFeedback(true);
                    }).finally((r) => {
                        this.update();
                    });
            },
            updateDescription(e) {
                const description = e.currentTarget.value.trim();
                if (description != "" && this.state.photo.description != description) {
                    this.state.photo.setDescription(description);
                    this.updatePhoto();
                }
            },
        }
    </script>
</upload_photo>
