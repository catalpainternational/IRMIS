<report>
    <header class="d-flex">
        <div>
            <a class="caret-dark left image" onclick="{ backToReports }"></a>
        </div>
        <div class="d-flex flex-column">
            <div class="align-items-center d-flex">
                <span class="paper image"></span>
                <h6>{ reportContent().title }</h6>
            </div>
            <div>
                <p>{ reportContent().description }.</p>
            </div>
        </div>
    </header>

    <div class="content-wrapper d-flex justify-content-between">
        <div class="d-flex flex-wrap">
            <div class="options">
                <select id="municipality_area_select2" multiple="true">
                    <option each="{ area in window.road_schema.administrative_area.options }" value="{ area.id }">{ area.name }</option>
                </select>
            </div>

            <div if="{ !reportContent().fixedFilter.roadtype }" class="options">
                <select id="road_class_select2" multiple="true">
                    <option each="{ road_class in window.road_schema.road_type.options }" value="{ road_class[0] }">{ road_class[1] }</option>
                </select>
            </div>
            <!-- Optionally include the following to show the fixedFilter value (changing to the full option title) -->
            <!-- <div if="{ reportContent().fixedFilter.roadtype }" class="options">
                <span>{ reportContent().fixedFilter.roadtype }</span>
            </div> -->

            <div class="options">
                <select id="surface_type_select2" multiple="true">
                    <option each="{ surface_type in window.road_schema.surface_type.options }" value="{ surface_type.code }">{ surface_type.name }</option>
                </select>
            </div>

            <div class="options">
                <select id="surface_condition_select2" multiple="true">
                    <option each="{ surface_condition in window.road_schema.surface_condition.options }" value="{ surface_condition[0] }">{ surface_condition[1] }</option>
                </select>
            </div>

            <div>
                <div class="options">
                    <select id="road_code_select2" multiple="true">
                        <option each="{ code in window.road_schema.road_code.options }" value="{ code.road_code }">{ code.road_code }</option>
                    </select>
                </div>
                <div class="d-flex flex-wrap">
                    <div class="d-flex flex-column">
                        <label>{ window.gettext("Chainage start") }</label>
                        <input class="{ state.reportStartChainage ? '' : 'inactive' } form-control form-control-sm" type="number" oninput="{ selectStartChainage }" placeholder="0">
                    </div>
                    <div class="d-flex flex-column">
                        <label>{ window.gettext("Chainage end") }</label>
                        <input class="{ state.reportEndChainage ? '' : 'inactive' } form-control form-control-sm" type="number" oninput="{ selectEndChainage }" placeholder="20000">
                    </div>
                </div>
            </div>

            <input class="{ state.reportDate ? '' : 'inactive' } form-control form-control-sm" type="date" oninput="{ selectDate }" value="{ current_date() }" max="{ max_date() }" placeholder="Select Date" pattern="\d{4}-\d{2}-\d{2}">
        </div>
        <div>
            <button type="button" class="btn btn-primary" onclick="{ createReport }" data-id="{ props.id }">{ window.gettext("Create Report") }</button>
        </div>
    </div>

    <div hidden="{ state.noReport }" class="content-wrapper report-content">
        <div class="align-items-center d-flex justify-content-between">
            <h6>{ reportContent().title } { window.gettext("Report") }</h6>
            <button class="btn btn-secondary btn-sm">{ window.gettext("Print") }</button>
        </div>
        <div class="filtered-segment d-flex flex-column">
            <h6>A01-01</h6>
            <h6>Chainage 0+000 to 2+360</h6>
        </div>
        <span>{ window.gettext("Created on") } 16 July 2019 - { window.gettext("Report for") } 16 September 2019</span>
        <div class="d-flex flex-column filters-applied">
            <p>{ window.gettext("Filters applied") }</p>
            <div class="d-flex">
                <div class="d-flex flex-column filter">
                    <span>Municipality:</span>
                    <span>Aileu, Dili</span>
                </div>
                <div class="d-flex flex-column filter">
                    <span>Surface Type:</span>
                    <span>Gravel</span>
                </div>
            </div>
        </div>
        <div if="{state.reportData.totalLength}" class="d-flex flex-column total-length">
            <p>{ window.gettext("Total Length") }</p>
            <h1>{ (state.reportData.totalLength / 1000).toFixed(1) } km</h1>
        </div>
        <data_table table_id="{dataTableIds.roadStatus}" tableName="Road Status" columns="{baseColumns}" columnSortOrder="{baseColumnSortOrder}" paging="false" canExport></data_table>
        <data_table table_id="{dataTableIds.technicalClass}" tableName="Technical Class" columns="{baseColumns}" columnSortOrder="{baseColumnSortOrder}" paging="false" canExport></data_table>
    </div>

    <div if="{ state.noReport }" class="align-items-center blank content-wrapper d-flex flex-column justify-content-center">
        <span class="no-report image"></span>
        <h6>
            { window.gettext("Please select a road above to view") }
            { reportContent().title }
        </h6>
        <p>
            { window.gettext("The report will be shown in this area and will provide you with detailed") }
            { reportContent().title }
            { window.gettext("information per segment of the selected road.") }
        </p>
    </div>

    <script>
        import { getRoadReport } from "../reportManager";

        import $ from "jquery";
        import "select2/dist/js/select2.full.min.js";
        import dayjs from "dayjs";

        const baseColumnSortOrder = [[0, 'asc']];

        export default {
            state: {
                noReport: true,
                reportMunicipality: [],
                reportRoadClass: [],
                reportSurfaceType: [],
                reportSurfaceCondition: [],
                reportRoadCode: null,
                reportStartChainage: null,
                reportEndChainage: null,
                reportDate: true,
                reportContent: {
                    0: {
                        title: window.gettext("Road Network Length"),
                        description: window.gettext("A report on the total length of the road network. The report provides total length in kilometers and percentages according to Road Status and Technical Class. A number of filters can be selected in order to generate a length report according to the required criteria"),
                        fixedFilter: {},
                    },
                    1: {
                        title: window.gettext("Road Network Length Breakdown"),
                        description: window.gettext("A breakdown report on the total length of the road network. The report provides information on total length in kilometers and percentages as well as Road Status and Technical Class, according to a breakdown by Municipality, Road Class and Surface Type"),
                        fixedFilter: {},
                    },
                    2: {
                        title: window.gettext("Surface Condition"),
                        description: window.gettext("A report on Road Surface Condition. This report provides detailed Surface Condition information per segment"),
                        fixedFilter: {},
                    },
                    3: { 
                        title: window.gettext("IRI Roughness"),
                        description: window.gettext("A report on Road IRI data. This report provides detailed information on a Road's Roughness per segment"),
                        fixedFilter: {},
                    },
                    4: {
                        title: window.gettext("Road Network Length - National Class"),
                        description: window.gettext("A report on the total length of National Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for National Roads"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "NAT",
                        },
                    },
                    5: {
                        title: window.gettext("Road Network Length - Municipal Class"),
                        description: window.gettext("A report on the total length of Municipal Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Municipal Roads"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "MUN",
                        },
                    },
                    6: {
                        title: window.gettext("Road Network Length - Rural Class"),
                        description: window.gettext("A report on the total length of Rural Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Rural Roads"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "RUR",
                        },
                    },
                    7: {
                        title: window.gettext("Road Network Length - Highway Class"),
                        description: window.gettext("A report on the total length of Highways. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Highways"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "HIGH",
                        },
                    },
                    8: {
                        title: window.gettext("Road Network Length - Urban Class"),
                        description: window.gettext("A report on the total length of Urban Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Urban Roads"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "URB",
                        },
                    },
                },
                reportData: {},
            },
            dataTableIds: {
                roadStatus: "report-road-status-table",
                technicalClass: "report-technical-class-table",
            },
            baseColumns: [
                {
                    // Title needs to be set per data type
                    title: window.gettext("Title"),
                    data: "title",
                    defaultContent: "",
                    orderable: false,
                },
                {
                    title: window.gettext("Length (km)"),
                    data: "distance",
                    defaultContent: "",
                    className: "text-right",
                    orderable: false,
                    render: (data, type) => {
                        return (type === 'display')
                            ? (data / 1000).toFixed(2)
                            : data;
                    },
                },
                {
                    title: window.gettext("Percentages (%)"),
                    data: "percent",
                    defaultContent: "",
                    className: "text-right",
                    orderable: false,
                },
            ],
            reportContent() {
                const reportId = this.props.id;
                return this.state.reportContent[reportId];
            },
            onMounted() {
                this.prepareSelects("municipality_area_select2", "Municipality", "reportMunicipality");
                this.prepareSelects("road_class_select2", "Road class", "reportRoadClass");
                this.prepareSelects("surface_type_select2", "Surface type", "reportSurfaceType");
                this.prepareSelects("surface_condition_select2", "Surface condition", "reportSurfaceCondition");
                this.prepareSelects("road_code_select2", "", "reportRoadCode", false);
            },
            prepareSelects(selectId, placeHolder, dataIn, isMulti = true) {
                const selectOptions = {
                    width: "225px",
                    containerCssClass: "report-select2",
                    dropdownCssClass: "report-dropdown-select2",
                };
                let toggleFunction = this.toggleMultipleSelect2;
                if (isMulti) {
                    selectOptions.placeholder = window.gettext(placeHolder)
                } else {
                    selectOptions.multiple = false;
                    toggleFunction = this.toggleSingleSelect2;
                }

                $(`#${selectId}`).select2(selectOptions);
                $(`#${selectId}`).on('select2:select', null, dataIn, toggleFunction);
                $(`#${selectId}`).on('select2:unselect', null, dataIn, toggleFunction);
            },
            backToReports() {
                window.location.hash = "reports/";
            },
            selectDate(e) {
                this.update({
                    reportDate: e.currentTarget.value,
                });
            },
            max_date: () => new Date().toISOString().substring(0, 10),
            current_date: () => dayjs(new Date()).format('YYYY-MM-DD'),
            selectStartChainage(e) {
                this.update({
                    reportStartChainage: e.currentTarget.value,
                });
            },
            selectEndChainage(e) {
                this.update({
                    reportEndChainage: e.currentTarget.value,
                });
            },
            toggleMultipleSelect2(e) {
                const selectElement = e.currentTarget;
                const inputElement = selectElement.nextSibling.children.item(0).firstElementChild;
                const selectedOptions = selectElement.selectedOptions;
                let values = [];

                for (let option of selectedOptions) {
                    values.push(option.text)
                };
                this.state[e.data] = values;

                if (selectElement.value !== "") {
                    inputElement.classList.add("active");
                } else {
                    inputElement.classList.remove("active");
                }
            },
            toggleSingleSelect2(e) {
                this.state[e.data] = e.currentTarget.value;
            },
            prepareTableData(tableName, tableData) {
                const haveTableData = tableData.length > 0;

                if (haveTableData) {
                    this.state.reportData.totalLength = this.state.reportData.totalLength || tableData.reduce((acc, cur) => acc += cur.distance || 0, 0);
                    tableData.forEach((entry) => {
                        if (this.state.reportData.totalLength > 0) {
                            entry.percent = Math.round((entry.distance / this.state.reportData.totalLength) * 10000) / 100;
                        } else {
                            // 100% of 0km - but this won't appear in the label
                            entry.percent = 100;
                        }
                        entry.getId = () => { return entry.key; };
                        if (entry.title.toLowerCase() === "unknown") {
                            let entryKey = `${entry.key}`.toLowerCase();
                            if (["0", "none", "unknown"].indexOf(entryKey) !== -1) {
                                entryKey == "Unknown";
                            }
                            entry.title = window.gettext(entryKey);
                        }
                    });
                    const eventName = `${tableName}.dataAdded`;
                    const eventDetail = { detail: { pendingRows: tableData, clearRows: true }};
                    document.dispatchEvent(new CustomEvent(eventName, eventDetail));
                }

                return tableData;
            },
            createReport(e) {
                $('#loading').modal('show');

                const reportId = e.currentTarget.dataset.id;
                const filters = this.reportContent().fixedFilter;

                switch (reportId) {
                    case "4":
                        filters["roadtype"] = "NAT";
                        break;
                    case "5":
                        filters["roadtype"] = "MUN";
                        break;
                    case "6":
                        filters["roadtype"] = "RUR";
                        break;
                    case "7":
                        filters["roadtype"] = "HIGH";
                        break;
                    case "8":
                        filters["roadtype"] = "URB";
                        break;
                }

                if (!Object.keys(filters).length) {
                    return;
                }

                getRoadReport(filters)
                    .then((surveyReportData) => {
                        if (surveyReportData) {
                            this.state.noReport = false;
                            const haveLengths = !!surveyReportData.lengths;
                            // This may not work - might need to delete/replace all members one by one - @$@#$@# Riot
                            this.state.reportData = {totalLength: 0};
                            if (haveLengths) {
                                const surfaceConditions = surveyReportData.surfaceConditions;
                                const haveSurfaceConditions = surfaceConditions.length > 0;

                                this.state.reportData.roadStatus = this.prepareTableData(this.dataTableIds.roadStatus, surveyReportData.roadStatuses);
                                this.state.reportData.technicalClass = this.prepareTableData(this.dataTableIds.technicalClass, surveyReportData.technicalClasses);
                            }
                            this.props.showFeedback();
                        } else {
                            this.props.showFeedback(true);
                            this.state.noReport = true;
                        }
                    }).catch(err => {
                        this.props.showFeedback(true);
                        this.state.noReport = true;
                    }).finally((r) => {
                        $('#loading').modal('hide');
                        this.update();
                    });
            },
        }
    </script>
</report>
