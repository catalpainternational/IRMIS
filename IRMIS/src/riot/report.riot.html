<report>
    <div class="print-header">
        <div class="align-items-center d-flex">
            <span class="image rdtl"></span>
            <div class="d-flex flex-column">
                <span>{ window.gettext("Democratic Republic of Timor-Leste") }</span>
                <span>{ window.gettext("Ministry of Public Works") }</span>
                <span>{ window.gettext("Directorate General for Public Works") }</span>
                <span>{ window.gettext("National Directorate for Roads, Bridges and Flood Control") }</span>
                <small>Avenida da Restauração, Rai Kotu, Díli, Timor-Leste, Telf. +670 3311408</small>
            </div>
        </div>
    </div>

    <header>
        <div>
            <a class="caret-dark left image" onclick="{ backToReports }"></a>
        </div>
        <div class="d-flex flex-column">
            <div class="align-items-center d-flex">
                <span class="paper image"></span>
                <h6>{ reportContent().title }</h6>
            </div>
            <div>
                <p>{ reportContent().description }.</p>
            </div>
        </div>
    </header>

    <div class="content-wrapper report-criteria">
        <h6>{ window.gettext("Select report criteria") }</h6>
        <div class="d-flex justify-content-between">
            <div class="d-flex flex-wrap">
                <div if="{ reportContent().visibleFilters.municipality }" class="options">
                    <select id="municipality_area_select2" multiple="true">
                        <option each="{ area in window.road_schema.administrative_area.options }" value="{ area.id }">{ area.name }</option>
                    </select>
                </div>

                <div if="{ reportContent().visibleFilters.roadClass }" class="options">
                    <select id="road_class_select2" multiple="true">
                        <option each="{ road_class in window.road_schema.road_type.options }" value="{ road_class[0] }">{ road_class[1] }</option>
                    </select>
                </div>
                <!-- Optionally include the following to show the fixedFilter value (changing to the full option title) -->
                <!-- <div if="{ reportContent().fixedFilter.roadtype }" class="options">
                    <span>{ reportContent().fixedFilter.roadtype }</span>
                </div> -->

                <div if="{ reportContent().visibleFilters.surfaceType }" class="options">
                    <select id="surface_type_select2" multiple="true">
                        <option each="{ surface_type in window.road_schema.surface_type.options }"
                            value="{ surface_type.code }">{ surface_type.name }</option>
                    </select>
                </div>

                <div if="{ reportContent().visibleFilters.surfaceCondition }" class="options">
                    <select id="surface_condition_select2" multiple="true">
                        <option each="{ surface_condition in window.road_schema.surface_condition.options }"
                            value="{ surface_condition[0] }">{ surface_condition[1] }</option>
                    </select>
                </div>

                <div if="{ reportContent().visibleFilters.roadCode }">
                    <div class="options">
                        <select id="road_code_select2" multiple="true">
                            <option each="{ code in window.road_schema.road_code.options }"
                                value="{ code.road_code }">{ code.road_code }</option>
                        </select>
                    </div>
                    <div class="d-flex flex-wrap">
                        <div class="d-flex flex-column">
                            <label>{ window.gettext("Chainage start") }</label>
                            <input class="{ state.reportStartChainage ? '' : 'inactive' } form-control form-control-sm"
                                type="number" oninput="{ selectStartChainage }" placeholder="0">
                        </div>
                        <div class="d-flex flex-column">
                            <label>{ window.gettext("Chainage end") }</label>
                            <input class="{ state.reportEndChainage ? '' : 'inactive' } form-control form-control-sm"
                                type="number" oninput="{ selectEndChainage }" placeholder="20000">
                        </div>
                    </div>
                </div>

                <input if="{ reportContent().visibleFilters.reportDate }"
                    class="{ state.reportDate ? '' : 'inactive' } form-control form-control-sm" type="date"
                    oninput="{ selectDate }" value="{ current_date() }" max="{ max_date() }" placeholder="Select Date"
                    pattern="\d{4}-\d{2}-\d{2}">
            </div>
            <div>
                <button type="button" class="btn btn-primary" onclick="{ createReport }" data-id="{ props.id }">{ window.gettext("Create Report") }</button>
            </div>
        </div>
    </div>

    <div hidden="{ state.noReport || state.noReportData }" class="content-wrapper report-content">
        <div class="align-items-center d-flex justify-content-between">
            <h1 class="print-title">{ window.gettext("Road Asset Management") }</h1>
            <h6>{ reportContent().title } { window.gettext("Report") }</h6>
            <button class="btn btn-secondary btn-sm" onclick="{ () => window.print() }">{ window.gettext("Print") }</button>
        </div>

        <div class="filtered-segment" hidden="{ !hasRoadCodeAndChainage() }">
            <h6 if="{ state.reportData.roadCodes && state.reportData.roadCodes.length === 1 }">{ window.gettext("Road") } { state.reportData.roadCodes[0] }</h6>
            <h6 if="{ state.reportData.reportChainage }">, { window.gettext("Chainage") } { toChainageFormat(state.reportData.reportChainage[0]) } { window.gettext("to") } { toChainageFormat(state.reportData.reportChainage[1]) }</h6>
        </div>

        <span class="report-date" if="{ state.reportData.dateCreated }">{ window.gettext("Created on") } { state.reportData.dateCreated() }</span>

        <!-- <div class="filters-applied" hidden="{ !hasFilters() }">
            <p>{ window.gettext("Filters applied") }</p>
            <div class="d-flex">
                <div class="d-flex flex-column filter">
                    <span>Municipality:</span>
                    <span>Aileu, Dili</span>
                </div>
                <div class="d-flex flex-column filter">
                    <span>Surface Type:</span>
                    <span>Gravel</span>
                </div>
            </div>
        </div> -->

        <div if="{state.reportData.totalLength}" class="d-flex flex-column total-length" hidden="{ !hasTotalLength() }">
            <p>{ window.gettext("Total Length") }</p>
            <h1>{ (state.reportData.totalLength / 1000).toFixed(2) } km</h1>
        </div>

        <stacked_bar hidden="{ !state.road_status || !hasStackedBar(stackedBarIds.roadStatus) }" 
            id="{ stackedBarIds.roadStatus }" title="{ window.gettext('Road Status') }"
            entries="{ state.road_status }" total_title="{ window.gettext('Total road chainage') }">
        </stacked_bar>
        <stacked_bar hidden="{ !state.technical_class || !hasStackedBar(stackedBarIds.technicalClass) }" 
            id="{ stackedBarIds.technicalClass }" title="{ window.gettext('Technical Class') }"
            entries="{ state.technical_class }" total_title="{ window.gettext('Total road chainage') }">
        </stacked_bar>
        <stacked_bar hidden="{ !state.surface_condition || !hasStackedBar(stackedBarIds.surfaceCondition) }" 
            id="{ stackedBarIds.surfaceCondition }" title="{ window.gettext('Surface Condition (SDI)') }"
            entries="{ state.surface_condition }" total_title="{ window.gettext('Total road chainage') }">
        </stacked_bar>

        <data_table hidden="{ !state.reportData.municipality || !hasDataTable(dataTableIds.municipality) }"
            table_id="{dataTableIds.municipality}" tableName="Municipality"
            columns="{columns.municipality()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
        <data_table hidden="{ !state.reportData.roadClass || !hasDataTable(dataTableIds.roadClass) }"
            table_id="{dataTableIds.roadClass}" tableName="Road Class"
            columns="{columns.roadClass()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
        <data_table hidden="{ !state.reportData.surfaceType || !hasDataTable(dataTableIds.surfaceType) }"
            table_id="{dataTableIds.surfaceType}" tableName="Surface Type"
            columns="{columns.surfaceType()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
        <data_table hidden="{ !state.reportData.roadStatus || !hasDataTable(dataTableIds.roadStatus) }"
            table_id="{dataTableIds.roadStatus}" tableName="Road Status"
            columns="{columns.roadStatus()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
        <data_table hidden="{ !state.reportData.technicalClass || !hasDataTable(dataTableIds.technicalClass) }"
            table_id="{dataTableIds.technicalClass}" tableName="Technical Class"
            columns="{columns.technicalClass()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
        <data_table hidden="{ !state.reportData.surfaceCondition || !hasDataTable(dataTableIds.surfaceCondition) }"
            table_id="{dataTableIds.surfaceCondition}" tableName="Surface Condition"
            columns="{columns.surfaceCondition()}" columnSortOrder="{baseColumnSortOrder}"
            paging="false" canExport>
        </data_table>
    </div>

    <div if="{ state.noReport }" class="align-items-center blank content-wrapper d-flex flex-column justify-content-center">
        <span class="no-report image"></span>
        <h6>{ reportContent().noReportTitle }</h6>
        <p>{ reportContent().noReportDescription }</p>
    </div>

    <div if="{ state.noReportData }" class="align-items-center blank content-wrapper d-flex flex-column justify-content-center">
        <span class="no-report-data image"></span>
        <h6>{ reportContent().noReportData }</h6>
    </div>

    <div class="print-footer">
        <div class="d-flex align-items-center" if="{ state.reportData.dateCreated }">{ window.gettext("Exported from Estrada on") } { state.reportData.dateCreated() }</div>
        <span class="app-logo image"></span>
    </div>

    <script>
        import Stacked_Bar from "./stacked_bar.riot.html";

        import { getRoadReport } from "../reportManager";
        import { updateReportAttributeSummary } from "../roadAttributes";
        import { cloneData, toChainageFormat } from "../assets/protoBufUtilities";

        import $ from "jquery";
        import "select2/dist/js/select2.full.min.js";
        import dayjs from "dayjs";

        const baseColumnSortOrder = [[0, 'asc']];

        const columnSource = {
            title: {
                // Title needs to be set per data type
                title: window.gettext("Title"),
                data: "title",
                defaultContent: "",
                orderable: false,
            },
            distance: {
                title: window.gettext("Length (km)"),
                data: "distance",
                defaultContent: "",
                className: "text-right",
                orderable: false,
                render: (data, type) => {
                    return (type === 'display')
                        ? (data / 1000).toFixed(2)
                        : data;
                },
            },
            percent: {
                title: window.gettext("Percentages (%)"),
                data: "percent",
                defaultContent: "",
                className: "text-right",
                orderable: false,
            },
            chainageStart: {
                title: window.gettext("Chainage Start"),
                data: "chainageStart",
                defaultContent: "",
                className: "text-right",
                orderable: false,
                render: (data, type) => {
                    return (type === 'display') ? toChainageFormat(data) : data;
                },
            },
            chainageEnd: {
                title: window.gettext("Chainage End"),
                data: "chainageEnd",
                defaultContent: "",
                className: "text-right",
                orderable: false,
                render: (data, type) => {
                    return (type === 'display') ? toChainageFormat(data) : data;
                },
            },
            municipality: {
                title: window.gettext("Municipality"),
                data: "municipality",
                defaultContent: "",
                orderable: false,
            },
            roadClass: {
                title: window.gettext("Road Class"),
                data: "roadClass",
                defaultContent: "",
                orderable: false,
            },
            surfaceCondition: {
                title: window.gettext("Surface Condition (SDI)"),
                data: "surfaceCondition",
                defaultContent: "",
                orderable: false,
            },
            surfaceType: {
                title: window.gettext("Surface Type"),
                data: "surfaceType",
                defaultContent: "",
                orderable: false,
            },
            surveyDate: {
                title: window.gettext("Survey Date"),
                data: "dateSurveyed",
                defaultContent: "",
                orderable: false,
            },
        };

        // Ids of the report elements
        const stackedBarIds = {
            roadStatus: "report-road-status-bar",
            technicalClass: "report-technical-class-bar",
            surfaceCondition: "report-surface-condition-bar",
        };
        const dataTableIds = {
            municipality: "report-municipality-table",
            roadClass: "report-road-class-table",
            surfaceType: "report-surface-type-table",
            roadStatus: "report-road-status-table",
            technicalClass: "report-technical-class-table",
            surfaceCondition: "report-surface-condition-table",
        };

        const allReportElements = {
            stackedBars: [stackedBarIds.roadStatus, stackedBarIds.technicalClass, stackedBarIds.surfaceCondition],
            tables: [
                dataTableIds.municipality, 
                dataTableIds.roadClass, 
                dataTableIds.surfaceType,
                dataTableIds.roadStatus, 
                dataTableIds.technicalClass, 
                dataTableIds.surfaceCondition,
            ],
        };

        export default {
            state: {
                noReport: true,
                noReportData: false,
                filterDefinitions: [
                    { selectId: "municipality_area_select2", placeHolder: "Municipality", dataIn: "reportMunicipality", filterName: "municipality" },
                    { selectId: "road_class_select2", placeHolder: "Road class", dataIn: "reportRoadClass", filterName: "roadtype" },
                    { selectId: "surface_type_select2", placeHolder: "Surface type", dataIn: "reportSurfaceType", filterName: "surfacetype" },
                    { selectId: "surface_condition_select2", placeHolder: "Surface condition", dataIn: "reportSurfaceCondition", filterName: "surfacecondition" },
                    { selectId: "road_code_select2", placeHolder: "Road code", dataIn: "reportRoadCode", isSingle: true, filterName: "roadcode" },
                ],
                reportMunicipality: [],
                reportRoadClass: [],
                reportSurfaceType: [],
                reportSurfaceCondition: [],
                reportRoadCode: null,
                reportStartChainage: null,
                reportEndChainage: null,
                reportDate: true,
                reportContent: {
                    0: {
                        title: window.gettext("Road Network Length"),
                        description: window.gettext("A report on the total length of the road network. The report provides total length in kilometers and percentages according to Road Status and Technical Class. A number of filters can be selected in order to generate a length report according to the required criteria"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information. You can use filters to generate a customized report"),
                        noReportData: window.gettext("Sorry, data for the road network is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                        },
                        visibleFilters: {
                            municipality: true,
                            roadClass: true,
                            surfaceType: true,
                            surfaceCondition: true,
                            reportDate: true,
                        },
                        reportElements: { filters: true, totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                    1: {
                        title: window.gettext("Road Network Length Breakdown"),
                        description: window.gettext("A breakdown report on the total length of the road network. The report provides information on total length in kilometers and percentages as well as Road Status and Technical Class, according to a breakdown by Municipality, Road Class and Surface Type"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length Breakdown report"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length Breakdown information. You can use filters to generate a customized report"),
                        noReportData: window.gettext("Sorry, data for the road network is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["municipality", "road_class", "surface_type"],
                        },
                        visibleFilters: {
                            municipality: true,
                            roadClass: true,
                            surfaceType: true,
                            surfaceCondition: true,
                            reportDate: true,
                        },
                        reportElements: { filters: true, totalLength: true, dataTables: [dataTableIds.municipality, dataTableIds.roadClass, dataTableIds.surfaceType] },
                    },
                    2: {
                        title: window.gettext("Surface Condition"),
                        description: window.gettext("A report on Road Surface Condition. This report provides detailed Surface Condition information per segment"),
                        noReportTitle: window.gettext("Please select a road above to view Surface Condition reports"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Surface Condition information per segment of the selected road"),
                        noReportData: window.gettext("Sorry, Surface Condition data is not available for the selected road"),
                        fixedFilter: {
                            primaryattribute: ["surface_condition"],
                        },
                        visibleFilters: {
                            roadCode: true,
                            reportDate: true,
                        },
                        reportElements: { roadCodeAndChainage: true, stackedBars: [stackedBarIds.surfaceCondition], dataTables: [dataTableIds.surfaceCondition] },
                    },
                    3: {
                        title: window.gettext("IRI Roughness"),
                        description: window.gettext("A report on Road IRI data. This report provides detailed information on a Road's Roughness per segment"),
                        noReportTitle: window.gettext("Please select a road above to view IRI Roughness reports"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed IRI Roughness information per segment of the selected road"),
                        noReportData: window.gettext("Sorry, IRI Roughness data is not available for the selected road"),
                        fixedFilter: {},
                        visibleFilters: {
                            roadCode: true,
                            reportDate: true,
                        },
                        reportElements: { roadCodeAndChainage: true },
                    },
                    4: {
                        title: window.gettext("Road Network Length - National Class"),
                        description: window.gettext("A report on the total length of National Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for National Roads"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report for National roads"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information for National class roads"),
                        noReportData: window.gettext("Sorry, data for National Class roads is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "NAT",
                        },
                        visibleFilters: {
                            reportDate: true,
                        },
                        reportElements: { totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                    5: {
                        title: window.gettext("Road Network Length - Municipal Class"),
                        description: window.gettext("A report on the total length of Municipal Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Municipal Roads"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report for Municipal roads"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information for Municipal class roads"),
                        noReportData: window.gettext("Sorry, data for Municipal Class roads is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "MUN",
                        },
                        visibleFilters: {
                            reportDate: true,
                        },
                        reportElements: { totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                    6: {
                        title: window.gettext("Road Network Length - Rural Class"),
                        description: window.gettext("A report on the total length of Rural Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Rural Roads"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report for Rural roads"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information for Rural class roads"),
                        noReportData: window.gettext("Sorry, data for Rural Class roads is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "RUR",
                        },
                        visibleFilters: {
                            reportDate: true,
                        },
                        reportElements: { totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                    7: {
                        title: window.gettext("Road Network Length - Highway Class"),
                        description: window.gettext("A report on the total length of Highways. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Highways"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report for Highways"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information for Highway class roads"),
                        noReportData: window.gettext("Sorry, data for Highway Class roads is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "HIGH",
                        },
                        visibleFilters: {
                            reportDate: true,
                        },
                        reportElements: { totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                    8: {
                        title: window.gettext("Road Network Length - Urban Class"),
                        description: window.gettext("A report on the total length of Urban Class roads. The report provides total length in kilometers and percentages according to Road Status and Technical Class for Urban Roads"),
                        noReportTitle: window.gettext("Click on Create Report button to access the Road Network Length report for Urban roads"),
                        noReportDescription: window.gettext("The report will be shown in this area and will provide you with detailed Road Network Length information for Urban class roads"),
                        noReportData: window.gettext("Sorry, data for Urban Class roads is not available yet"),
                        fixedFilter: {
                            primaryattribute: ["road_status", "technical_class"],
                            roadtype: "URB",
                        },
                        visibleFilters: {
                            reportDate: true,
                        },
                        reportElements: { totalLength: true, dataTables: [dataTableIds.roadStatus, dataTableIds.technicalClass] },
                    },
                },
                reportData: {},
                road_status: [{ key: 0, title: "unknown", distance: 0, percent: 100, label: window.gettext("Loading") }],
                technical_class: [{ key: 0, title: "unknown", distance: 0, percent: 100, label: window.gettext("Loading") }],
                surface_condition: [{ key: 0, title: "unknown", distance: 0, percent: 100, label: window.gettext("Loading") }],
            },
            components: {
                Stacked_Bar
            },
            stackedBarIds: stackedBarIds,
            dataTableIds: dataTableIds,
            columns: {
                municipality() {
                    const titleColumn = cloneData(columnSource.title);
                    titleColumn.title = window.gettext("Municipality");

                    return [titleColumn, columnSource.distance, columnSource.percent];
                },
                roadClass() {
                    const titleColumn = cloneData(columnSource.title);
                    titleColumn.title = window.gettext("Road Class");

                    return [titleColumn, columnSource.distance, columnSource.percent];
                },
                surfaceType() {
                    const titleColumn = cloneData(columnSource.title);
                    titleColumn.title = window.gettext("Surface Type");

                    return [titleColumn, columnSource.distance, columnSource.percent];
                },
                roadStatus() {
                    const titleColumn = cloneData(columnSource.title);
                    titleColumn.title = window.gettext("Road Status");

                    return [titleColumn, columnSource.distance, columnSource.percent];
                },
                technicalClass() {
                    const titleColumn = cloneData(columnSource.title);
                    titleColumn.title = window.gettext("Technical Class");

                    return [titleColumn, columnSource.distance, columnSource.percent];
                },
                surfaceCondition() {
                    return [columnSource.chainageStart, columnSource.chainageEnd, columnSource.surfaceCondition, columnSource.surveyDate];
                },
            },
            reportContent() {
                const reportId = this.props.id;
                return this.state.reportContent[reportId];
            },
            reportElements() {
                return this.reportContent().reportElements || allReportElements;
            },
            hasFilters() {
                return this.reportElements().filters;
            },
            hasRoadCodeAndChainage() {
                return this.reportElements().roadCodeAndChainage;
            },
            hasTotalLength() {
                return this.reportElements().totalLength;
            },
            hasStackedBar(stackedBarId) {
                return (this.reportElements().stackedBars || []).indexOf(stackedBarId) > -1;
            },
            hasDataTable(dataTableId) {
                return (this.reportElements().dataTables || []).indexOf(dataTableId) > -1;
            },
            onMounted(props, state) {
                state.filterDefinitions.forEach((filterDefinition) => {
                    this.prepareSelects(filterDefinition);
                });

                this.prepareStackedBar(this.stackedBarIds.surfaceCondition, this.state.surfaceConditions, "surface_condition");
            },
            prepareSelects(filterDefinition) {
                const selectOptions = {
                    width: "225px",
                    containerCssClass: "report-select2",
                    dropdownCssClass: "report-dropdown-select2",
                };

                let toggleFunction = this.toggleMultipleSelect2;
                if (filterDefinition.isSingle) {
                    selectOptions.multiple = false;
                    toggleFunction = this.toggleSingleSelect2;
                } else {
                    selectOptions.placeholder = window.gettext(filterDefinition.placeHolder)
                }

                $(`#${filterDefinition.selectId}`).select2(selectOptions);
                $(`#${filterDefinition.selectId}`).on('select2:select', null, filterDefinition.dataIn, toggleFunction);
                $(`#${filterDefinition.selectId}`).on('select2:unselect', null, filterDefinition.dataIn, toggleFunction);
            },
            backToReports() {
                window.location.hash = "reports/";
            },
            selectDate(e) {
                this.update({
                    reportDate: e.currentTarget.value,
                });
            },
            max_date: () => new Date().toISOString().substring(0, 10),
            current_date: () => dayjs(new Date()).format('YYYY-MM-DD'),
            selectStartChainage(e) {
                this.update({
                    reportStartChainage: e.currentTarget.value,
                });
            },
            selectEndChainage(e) {
                this.update({
                    reportEndChainage: e.currentTarget.value,
                });
            },
            toggleMultipleSelect2(e) {
                const selectElement = e.currentTarget;
                const inputElement = selectElement.nextSibling.children.item(0).firstElementChild;
                const selectedOptions = selectElement.selectedOptions;
                let values = [];

                for (let option of selectedOptions) {
                    values.push(option.text)
                };
                this.state[e.data] = values;

                if (selectElement.value !== "") {
                    inputElement.classList.add("active");
                } else {
                    inputElement.classList.remove("active");
                }
            },
            toggleSingleSelect2(e) {
                this.state[e.data] = e.currentTarget.value;
            },
            prepareTableData(tableName, tableData, filterName) {
                const haveTableData = tableData.length > 0;
                const fixedFilter = this.reportContent().fixedFilter;
                const isFixedFilter = fixedFilter.primaryattribute
                    ? fixedFilter.primaryattribute.indexOf(filterName) !== -1
                    : false;

                if (haveTableData || isFixedFilter) {
                    this.state.reportData.totalLength = this.state.reportData.totalLength || tableData.reduce((acc, cur) => acc += cur.distance || 0, 0);
                    tableData.forEach((entry) => {
                        if (this.state.reportData.totalLength > 0) {
                            entry.percent = Math.round((entry.distance / this.state.reportData.totalLength) * 10000) / 100;
                        } else {
                            // 100% of 0km - but this won't appear in the label
                            entry.percent = 100;
                        }
                        entry.getId = () => { return entry.key; };
                        entry.title = window.gettext(entry.title || entry.key);
                    });
                    const eventName = `${tableName}.dataAdded`;
                    const eventDetail = { detail: { pendingRows: tableData, clearRows: true } };
                    document.dispatchEvent(new CustomEvent(eventName, eventDetail));

                    return tableData || [];
                }

                return null;
            },
            prepareStackedBar(barName, barData, filterName) {
                if (barData && barData.length) {
                    updateReportAttributeSummary(this.state, filterName, barData);
                                    
                    const eventName = `${barName}.dataUpdated`;
                    const eventDetail = { detail: { entries: this.state[filterName], barName } };
                    document.dispatchEvent(new CustomEvent(eventName, eventDetail));
                } else {
                    delete this.state[filterName];
                }
            },
            toChainageFormat(value) {
                return toChainageFormat(value);
            },
            createReport(e) {
                $('#loading').modal('show');

                const reportId = e.currentTarget.dataset.id;
                const filters = cloneData(this.reportContent().fixedFilter);

                const userFilters = {};
                // Handle the select filters
                this.state.filterDefinitions.forEach((filterDefinition) => {
                    const requestFilterName = filterDefinition.filterName || "";
                    if (!requestFilterName || filters[requestFilterName]) {
                        // If the fixedFilters already defines this request filter
                        // then we will not accept this user defined one
                        return;
                    }

                    const selectData = $(`#${filterDefinition.selectId}`).select2("data");
                    if (!selectData || selectData.length === 0) {
                        return;
                    }
                    const selection = selectData.map((data) => { return data.id; });

                    filters[requestFilterName] = selection;
                });
                // Check for the other filters
                if (this.state.reportDate) {
                    filters["reportdate"] = this.state.reportDate;
                }
                if (this.state.reportStartChainage) {
                    filters["reportstartchainage"] = this.state.reportStartChainage;
                }
                if (this.state.reportEndChainage) {
                    filters["reportendchainage"] = this.state.reportEndChainage;
                }

                if (!Object.keys(filters).length) {
                    return;
                }

                getRoadReport(filters)
                    .then((surveyReportData) => {
                        if (surveyReportData) {
                            this.state.noReport = false;
                            const haveLengths = !!surveyReportData.lengths;

                            this.state.reportData = {
                                totalLength: 0,
                                roadCodes: (surveyReportData.roadCodes || []).sort(),
                                reportChainage: (surveyReportData.reportChainage && surveyReportData.reportChainage.length === 2 
                                    && (surveyReportData.reportChainage[0] + surveyReportData.reportChainage[1])) 
                                    ? surveyReportData.reportChainage 
                                    : undefined,
                                dateCreated: () => dayjs(new Date()).format('DD MMMM YYYY [at] HH:mm'),
                            };

                            if (haveLengths) {
                                this.state.reportData.municipality = this.prepareTableData(this.dataTableIds.municipality, surveyReportData.municipalities, "municipality");
                                this.state.reportData.roadClass = this.prepareTableData(this.dataTableIds.roadClass, surveyReportData.roadClasses, "road_class");
                                this.state.reportData.surfaceType = this.prepareTableData(this.dataTableIds.surfaceType, surveyReportData.surfaceTypes, "surface_type");

                                this.state.reportData.roadStatus = this.prepareTableData(this.dataTableIds.roadStatus, surveyReportData.roadStatuses, "road_status");
                                this.state.reportData.technicalClass = this.prepareTableData(this.dataTableIds.technicalClass, surveyReportData.technicalClasses, "technical_class");
                                this.state.reportData.surfaceCondition = this.prepareTableData(this.dataTableIds.surfaceCondition, surveyReportData.attributeTable("surface_condition", true), "surface_condition");

                                this.prepareStackedBar(this.stackedBarIds.roadStatus, surveyReportData.roadStatuses, "road_status");
                                this.prepareStackedBar(this.stackedBarIds.technicalClass, surveyReportData.technicalClasses, "technical_class");
                                this.prepareStackedBar(this.stackedBarIds.surfaceCondition, surveyReportData.surfaceConditions, "surface_condition");

                                const reportingTables = this.reportElements().dataTables;
                                this.state.noReportData = true;
                                if (reportingTables.includes(this.dataTableIds.municipality) && surveyReportData.municipalities.length ||
                                    reportingTables.includes(this.dataTableIds.roadClass) && surveyReportData.roadClasses.length ||
                                    reportingTables.includes(this.dataTableIds.surfaceType) && surveyReportData.surfaceTypes.length ||
                                    reportingTables.includes(this.dataTableIds.roadStatus) && surveyReportData.roadStatuses.length ||
                                    reportingTables.includes(this.dataTableIds.technicalClass) && surveyReportData.technicalClasses.length ||
                                    reportingTables.includes(this.dataTableIds.surfaceCondition) && surveyReportData.attributeTable("surface_condition", true).length) {
                                    this.state.noReportData = false;
                                }
                            } else {
                                this.state.noReportData = true;
                            }

                            this.props.showFeedback();
                        } else {
                            // An id of null should tell us that there was an error fetching the data
                            this.props.showFeedback(true);
                            this.state.noReport = true;
                        }
                    }).catch(err => {
                        this.props.showFeedback(true);
                        this.state.noReport = true;
                    }).finally((r) => {
                        $('#loading').modal('hide');
                        this.update();
                    });
            },
        }
    </script>
</report>
