<edit_structure_condition>
    <div class="content-wrapper">
        <div class="d-flex justify-content-between">
            <h5>{ window.gettext("Structure Condition") }</h5>
            <button class="btn btn-primary" onclick="{ showEditModal }" disabled="{ props.editing }">
                { window.gettext("Add") }
            </button>
        </div>

        <data_table table_id="{table_id}" columns="{table_columns}"
            columnSortOrder="{table_columns_order}" candelete=true>
        </data_table>
    </div>

    <edit_modal modal_id="{modal_id}" disableSave="{!state.canSave}">
        <span slot="modal_title">{window.gettext("Add Structure Condition Information")}</span>

        <form slot="modal_body">
            <section>
                <div class="form-group">
                    <label>{ window.gettext("Survey Date") }</label>
                    <span class="required">*</span>
                    <small class="form-text text-muted">{props.parent.getHelpText("survey_date")}</small>
                    <!-- It would be preferable to use the 'datetime-local' input type, however Firefox currently does not support it -->
                    <input
                        class="{state.errors.surveyDate ? 'danger' : null } { state.surveyDate ? '' : 'inactive' } form-control"
                        type="date" name="surveyDate" placeholder="Date" value="{state.surveyDate}"
                        oninput="{checkSurveyDate}" required pattern="\d{4}-\d{2}-\d{2}">
                    <div if="{state.errors.surveyDate}" class="invalid-tooltip">
                        <ul>
                            <li>{ state.errors.surveyDate }.</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section>
                <h6>{ window.gettext("Condition") }</h6>
                <div class="form-group">
                    <label>{conditions.display}</label>
                    <span class="required">*</span>
                    <small class="form-text text-muted">{window.gettext("Choose the structure condition")}</small>
                    <div if="{state.errors.structureCondition}" class="invalid-tooltip">
                        <ul>
                            <li>{ state.errors.structureCondition }.</li>
                        </ul>
                    </div>
                    <ul>
                        <li each="{condition in conditions.options}" data-condition="{condition[0]}"
                            onclick="{checkStructureCondition}">
                            <span
                                class="{ condition[0] == state.structureCondition ? 'active' : ''  } radio image"></span>
                            { condition[1] }
                        </li>
                    </ul>
                </div>
            </section>
            <section>
                <div class="form-group">
                    <label>{ window.gettext("Condition Description") }</label>
                    <input
                        class="{ state.errors.description ? 'danger' : null } { state.description ? '' : 'inactive' } form-control"
                        type="text" maxlength="500" placeholder="E.g." value="{ state.description }"
                        oninput="{ checkDescription }">
                    <div if="{state.errors.description}" class="invalid-tooltip">
                        <ul>
                            <li>{ state.errors.description }.</li>
                        </ul>
                    </div>
                    <small class="form-text text-muted">{window.gettext("Enter a description on the structure condition")}</small>
                </div>
            </section>
            <section>
                <h6>{ window.gettext("Upload photos") }</h6>
                <upload_photo></upload_photo>
                <input
                    class="{ state.errors.photo1 ? 'danger' : null } { state.photo1 ? '' : 'inactive' } form-control"
                    type="text" maxlength="500" placeholder="Enter a description of the photo" value="{ state.photo1 }"
                    oninput="{ checkPhotoText }">
                <div if="{state.errors.photo1}" class="invalid-tooltip">
                    <ul>
                        <li>{ state.errors.photo1 }.</li>
                    </ul>
                </div>
                <upload_photo></upload_photo>
                <input
                    class="{ state.errors.photo2 ? 'danger' : null } { state.photo2 ? '' : 'inactive' } form-control"
                    type="text" maxlength="500" placeholder="Enter a description of the photo" value="{ state.photo2 }"
                    oninput="{ checkPhotoText }">
                <div if="{state.errors.photo2}" class="invalid-tooltip">
                    <ul>
                        <li>{ state.errors.photo2 }.</li>
                    </ul>
                </div>
            </section>

            <div class="d-flex justify-content-end">
                <span>[</span><span class="required">*</span><span>]: Mandatory</span>
            </div>
        </form>
    </edit_modal>


    <edit_stop_alert modalId="delete-alert" title="{window.gettext('Delete')}"
        description="{window.gettext('Are you sure you want to delete this data entry?')}"
        proceedLabel="{window.gettext('Delete')}" proceedResult="delete" stopLabel="{window.gettext('Don\'t delete')}"
        stopResult="keep">
    </edit_stop_alert>

    <script>
        import Edit_Stop_Alert from "./edit_stop_alert.riot.html";
        import Data_Table from "./data_table.riot.html";
        import Edit_Modal from "./edit_modal.riot.html";
        import Upload_Photo from "./upload_photo.riot.html";

        import $ from "jquery";

        export default {
            state: {
                survey: {},
                canSave: false,
                errors: {},
                pendingRows: [],
                assetConditions: [{key: 0, title: "unknown", distance: 0, percent: 100, label: window.gettext("Loading")}],
                editMode: false,
                structureCondition: '',
                description: '',
                structurePhotos: [],
                surveyDate: ''
            },
            components: {
                Edit_Stop_Alert, Edit_Modal, Data_Table, Upload_Photo
            },

            // Condition Survey
            onMounted(props, state) {
                state.loading = true;
                state.road = props.road;

                this.deleteListener = (data) => {
                    const rowId = data.detail.rowId;
                    // Won't work just yet - waiting for the showStopAlertModal function to be defined in this riot tag
                    this.showStopAlertModal("delete-alert", rowId);
                };

                document.addEventListener(`${this.table_id}.deleteRow`, this.deleteListener);
            },
            onUnmount(props, state) {
                document.removeEventListener(`${this.table_id}.deleteRow`, this.deleteListener);
            },

            // Structure Condition Survey
            checkSurveyDate(e) {
                this.state.surveyDate = e.currentTarget.value;
                this.canSave();
            },
            checkStructureCondition(e) {
                this.state.structureCondition = e.currentTarget.dataset.condition;
                this.canSave();
            },
            showEditModal() {
                $(`#${this.modal_id}`).modal("show");
            },
            checkPhotoText(e) {
                this.structurePhotos = e.currentTarget.value;
            },
            canSave() {
                if (this.state.surveyDate == '' || this.state.structureCondition == '') { 
                    this.state.canSave = false;
                } else {
                    this.state.canSave = true;
                }
            },
            save(e) {
                $(`#${this.modal_id}`).modal("hide");
            },
            conditions: {
                display: window.gettext('Structure Condition'),
                options: [
                    [1, window.gettext("Good")],
                    [2, window.gettext("Fair")],
                    [3, window.gettext("Poor")],
                    [4, window.gettext("Bad")]
                ]
            },
            table_id: "asset-condition-table",
            table_columns_order: [[0, 'asc']],
            table_columns: [
                {
                    title: window.gettext("Survey date"),
                    data: "dateCreated",
                    defaultContent: "12/12/2019",
                    className: "text-center",
                },
                {
                    title: window.gettext("Condition"),
                    // data: "assetCondition",
                    defaultContent: "Good",
                    className: "text-center",
                    orderable: false,
                },
                {
                    title: window.gettext("Description"),
                    defaultContent: "Lorem ipsum dolor...",
                    className: "text-center",
                    orderable: false,
                },
                {
                    title: window.gettext("Photos"),
                    defaultContent: "View Photo",
                    render: r => `<a class="image" href=""></a>`,
                    className: "text-center",
                    orderable: false,
                },
                {
                    title: window.gettext("Added by"),
                    // data: "addedBy",
                    defaultContent: "Jose Soares",
                    orderable: false,
                },
                {
                    // To add a 'Delete' button include the attribute candelete=true
                    // on the Riot dataTable tag as well
                    title: window.gettext("Delete"),
                    name: "Option", // Do NOT translate this
                    defaultContent: "X",
                    className: "text-center",
                    orderable: false,
                },
            ],
            modal_id: "structure-condition-modal",
        }
    </script>
</edit_structure_condition>
